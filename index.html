<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkMorty</title>
    <style>
        /* Кастомный курсор */
        body {
            cursor: url('MOUS.png'), auto;
        }
        a, button, input, textarea, .post-action, .profile-menu-item, .playlist-btn {
            cursor: url('MOUS.png'), pointer;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #000;
            color: #e0e0e0;
            background-image: url('FON.png');
            background-repeat: repeat;
            background-attachment: fixed;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background-color: #111;
            border: 3px solid #b30000;
            padding: 15px;
            box-shadow: 0 0 15px rgba(179, 0, 0, 0.5);
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #b30000;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
            font-family: 'Courier New', monospace;
            cursor: pointer;
        }
        
        .user-panel {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }
        
        .btn-login {
            background-color: #b30000;
            color: white;
            border: 1px solid #ff0000;
        }
        
        .btn-login:hover {
            background-color: #ff0000;
        }
        
        .btn-register {
            background-color: transparent;
            border: 1px solid #b30000;
            color: #b30000;
        }
        
        .btn-register:hover {
            background-color: rgba(179, 0, 0, 0.2);
        }
        
        .btn-profile {
            background-color: #222;
            color: #b30000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #b30000;
        }
        
        .btn-profile:hover {
            background-color: #333;
        }
        
        .btn-logout {
            background-color: #222;
            color: #e0e0e0;
            border: 1px solid #b30000;
        }
        
        .btn-logout:hover {
            background-color: #b30000;
            color: white;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .sidebar {
            width: 250px;
            flex-shrink: 0;
        }
        
        .sidebar-widget {
            background-color: #111;
            border: 3px solid #b30000;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .widget-title {
            color: #b30000;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .content-area {
            flex-grow: 1;
        }
        
        .post-form {
            background-color: #111;
            border: 3px solid #b30000;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .post-form-title {
            color: #b30000;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            background-color: #222;
            border: 1px solid #b30000;
            border-radius: 3px;
            color: #e0e0e0;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn-submit {
            width: 100%;
            padding: 10px;
            background-color: #b30000;
            color: white;
            border: none;
            border-radius: 3px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .btn-submit:hover {
            background-color: #ff0000;
        }
        
        .posts-container {
            background-color: #111;
            border: 3px solid #b30000;
            padding: 20px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .post {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #333;
        }
        
        .post:last-child {
            border-bottom: none;
        }
        
        .post-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b30000;
            font-weight: bold;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid #b30000;
        }
        
        .post-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .post-content {
            flex-grow: 1;
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .post-author {
            color: #b30000;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .post-date {
            color: #808080;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .post-text {
            margin-bottom: 10px;
            line-height: 1.5;
            font-family: 'Courier New', monospace;
        }
        
        .post-media {
            margin: 10px 0;
            max-width: 100%;
        }
        
        .post-media img, .post-media video {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #333;
        }
        
        .post-actions {
            display: flex;
            gap: 15px;
        }
        
        .post-action {
            color: #808080;
            font-size: 12px;
            cursor: pointer;
            transition: color 0.3s;
            font-family: 'Courier New', monospace;
        }
        
        .post-action:hover {
            color: #b30000;
        }
        
        .comments-container {
            margin-top: 15px;
            padding-left: 15px;
            border-left: 2px solid #333;
        }
        
        .comment {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #333;
        }
        
        .comment:last-child {
            border-bottom: none;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .comment-author {
            color: #b30000;
            font-weight: bold;
        }
        
        .comment-date {
            color: #666;
        }
        
        .comment-text {
            font-size: 13px;
            line-height: 1.4;
        }
        
        .comment-form {
            margin-top: 15px;
            display: none;
        }
        
        .comment-form.active {
            display: block;
        }
        
        .reply-form {
            margin-top: 10px;
            display: none;
        }
        
        .reply-form.active {
            display: block;
        }
        
        .media-preview {
            margin-top: 10px;
            display: none;
        }
        
        .media-preview.active {
            display: block;
        }
        
        .media-preview img, .media-preview video {
            max-width: 200px;
            max-height: 200px;
            margin-top: 5px;
        }
        
        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #111;
            padding: 30px;
            border-radius: 0;
            width: 100%;
            max-width: 500px;
            border: 3px solid #b30000;
            position: relative;
            box-shadow: 0 0 20px rgba(179, 0, 0, 0.5);
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            color: #808080;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #b30000;
        }
        
        .modal-title {
            color: #b30000;
            margin-bottom: 20px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0a0;
            font-family: 'Courier New', monospace;
        }
        
        /* Страница профиля */
        .profile-header {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            align-items: center;
            background-color: #111;
            border: 3px solid #b30000;
            padding: 20px;
            box-shadow: 0 0 15px rgba(179, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .profile-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #b30000, #ff0000, #b30000);
        }
        
        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #b30000;
            font-size: 36px;
            font-weight: bold;
            flex-shrink: 0;
            overflow: hidden;
            border: 3px solid #b30000;
            box-shadow: 0 0 15px rgba(179, 0, 0, 0.5);
            z-index: 1;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .profile-info {
            flex-grow: 1;
            position: relative;
            z-index: 1;
        }
        
        .profile-info h2 {
            color: #b30000;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(179, 0, 0, 0.5);
        }
        
        .profile-info p {
            color: #a0a0a0;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        .stat-item {
            text-align: center;
            background-color: rgba(34, 34, 34, 0.7);
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #b30000;
        }
        
        .stat-value {
            color: #b30000;
            font-size: 20px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .stat-label {
            color: #808080;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .profile-content {
            display: flex;
            gap: 30px;
        }
        
        .profile-sidebar {
            width: 250px;
            flex-shrink: 0;
        }
        
        .profile-main {
            flex-grow: 1;
        }
        
        .profile-menu {
            background-color: #111;
            border: 3px solid #b30000;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .profile-menu-item {
            padding: 12px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            color: #e0e0e0;
        }
        
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        
        .profile-menu-item:hover, .profile-menu-item.active {
            background-color: #b30000;
            color: white;
        }
        
        .profile-section {
            background-color: #111;
            border: 3px solid #b30000;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .profile-section-title {
            color: #b30000;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }
        
        .avatar-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #222;
            margin-bottom: 15px;
            overflow: hidden;
            border: 2px solid #b30000;
        }
        
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Плейлист */
        .playlist-container {
            margin-top: 20px;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #222;
            margin-bottom: 5px;
            border-left: 3px solid #b30000;
        }
        
        .playlist-item-info {
            flex-grow: 1;
        }
        
        .playlist-item-title {
            color: #e0e0e0;
            font-weight: bold;
        }
        
        .playlist-item-artist {
            color: #a0a0a0;
            font-size: 12px;
        }
        
        .playlist-controls {
            display: flex;
            gap: 10px;
        }
        
        .playlist-btn {
            background: none;
            border: none;
            color: #b30000;
            cursor: pointer;
            font-size: 16px;
        }
        
        .add-playlist-form {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        
        .playlist-input {
            flex-grow: 1;
            padding: 8px;
            background-color: #222;
            border: 1px solid #b30000;
            color: #e0e0e0;
        }
        
        /* Закрепленный пост */
        .pinned-post {
            background-color: #222;
            border-left: 5px solid #b30000;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .pinned-post::before {
            content: "Закреплено";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
            color: #b30000;
            font-weight: bold;
        }
        
        /* Поиск по темам */
        .search-container {
            margin-bottom: 20px;
            background-color: #111;
            border: 3px solid #b30000;
            padding: 15px;
            box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
        }
        
        .search-form {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex-grow: 1;
            padding: 8px;
            background-color: #222;
            border: 1px solid #b30000;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }
        
        .search-btn {
            padding: 8px 15px;
            background-color: #b30000;
            color: white;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        
        .search-btn:hover {
            background-color: #ff0000;
        }
        
        /* Список онлайн пользователей */
        .online-users-list {
            list-style-type: none;
            font-family: 'Courier New', monospace;
        }
        
        .online-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            border-bottom: 1px dashed #333;
        }
        
        .online-user:last-child {
            border-bottom: none;
        }
        
        .online-user-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #b30000;
            border: 1px solid #b30000;
            overflow: hidden;
        }
        
        .online-user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Стили для результатов поиска песен */
        .search-results {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            background-color: #111;
        }
        
        .search-result-item {
            padding: 8px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-info {
            flex-grow: 1;
        }
        
        .search-result-title {
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .search-result-artist {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        .search-result-user {
            font-size: 12px;
            color: #b30000;
            margin-top: 3px;
        }
        
        .search-result-add {
            background-color: #b30000;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .search-result-add:hover {
            background-color: #ff0000;
        }
        
        /* Аудио плеер */
        .audio-player {
            width: 100%;
            margin-top: 10px;
            background-color: #222;
            padding: 10px;
            border: 1px solid #b30000;
        }
        
        /* Адаптивность */
        @media (max-width: 768px) {
            .main-content, .profile-content {
                flex-direction: column;
            }
            
            .sidebar, .profile-sidebar {
                width: 100%;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-stats {
                justify-content: center;
            }
            
            .search-form {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo" onclick="showMainContent()">DarkMorty</div>
            <div class="user-panel" id="userPanel">
                <!-- Будет заполнено JavaScript -->
            </div>
        </header>
        
        <div id="mainContent">
            <div class="main-content">
                <div class="sidebar">
                    <div class="sidebar-widget">
                        <div class="widget-title">О форуме</div>
                        <p style="font-family: 'Courier New', monospace;">Добро пожаловать на DarkRed SpaceHey - форум в стиле ретро, но с современными функциями!</p>
                    </div>
                    
                    <div class="sidebar-widget">
                        <div class="widget-title">Статистика</div>
                        <div style="font-family: 'Courier New', monospace;">
                            <p>Пользователей: <span id="totalUsers">0</span></p>
                            <p>Сообщений: <span id="totalPosts">0</span></p>
                            <p>Онлайн: <span id="onlineUsers">0</span></p>
                        </div>
                    </div>
                    
                    <div class="sidebar-widget" id="onlineUsersWidget">
                        <div class="widget-title">Сейчас онлайн</div>
                        <ul class="online-users-list" id="onlineUsersList">
                            <!-- Список онлайн пользователей будет здесь -->
                        </ul>
                    </div>
                </div>
                
                <div class="content-area">
                    <div class="search-container">
                        <form class="search-form" onsubmit="searchContent(event)">
                            <input type="text" class="search-input" id="searchQuery" placeholder="Поиск по темам, сообщениям и песням...">
                            <button type="submit" class="search-btn">Найти</button>
                        </form>
                        <div id="searchResults" class="search-results" style="display: none;"></div>
                    </div>
                    
                    <div class="post-form" id="postFormContainer" style="display: none;">
                        <h3 class="post-form-title">Создать пост</h3>
                        <form id="postForm" onsubmit="createPost(event)">
                            <input type="text" class="form-control" id="postTitle" placeholder="Заголовок (необязательно)">
                            <textarea class="form-control" id="postText" placeholder="Что у вас нового?" required></textarea>
                            <div class="form-group">
                                <label for="postMedia">Прикрепить фото/видео</label>
                                <input type="file" id="postMedia" class="form-control" accept="image/*,video/*" multiple>
                            </div>
                            <div id="mediaPreview" class="media-preview"></div>
                            <button type="submit" class="btn-submit">Опубликовать</button>
                        </form>
                    </div>
                    
                    <div class="posts-container">
                        <h3 class="widget-title" style="margin-top: 0;">Последние сообщения</h3>
                        <div id="postsList">
                            <!-- Посты будут загружаться здесь -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="profileContent" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">
                    <!-- Аватар будет загружен здесь -->
                </div>
                <div class="profile-info">
                    <h2 id="profileUsername">Username</h2>
                    <p id="profileEmail">user@example.com</p>
                    <p>Зарегистрирован: <span id="profileRegDate">01.01.2023</span></p>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profilePosts">0</div>
                            <div class="stat-label">Сообщений</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profileThreads">0</div>
                            <div class="stat-label">Тем</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profileReputation">0</div>
                            <div class="stat-label">Репутация</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-content">
                <div class="profile-sidebar">
                    <div class="profile-menu">
                        <div class="profile-menu-item active" onclick="showProfileTab('info')">Информация</div>
                        <div class="profile-menu-item" onclick="showProfileTab('posts')">Мои посты</div>
                        <div class="profile-menu-item" onclick="showProfileTab('playlist')">Плейлист</div>
                        <div class="profile-menu-item" onclick="showProfileTab('settings')">Настройки</div>
                        <div class="profile-menu-item" onclick="showMainContent()">На главную</div>
                    </div>
                    
                    <button class="btn btn-logout" onclick="logout()" style="width: 100%;">Выйти</button>
                </div>
                
                <div class="profile-main">
                    <div id="profileInfoTab" class="profile-section">
                        <div class="profile-section-title">Информация</div>
                        <p><strong>Имя:</strong> <span id="profileFullName">Не указано</span></p>
                        <p><strong>Местоположение:</strong> <span id="profileLocation">Не указано</span></p>
                        <p><strong>О себе:</strong></p>
                        <p id="profileBio">Пользователь пока ничего о себе не рассказал.</p>
                        
                        <!-- Закрепленный пост -->
                        <div class="profile-section-title" style="margin-top: 30px;">Закрепленный пост</div>
                        <div id="pinnedPostContainer">
                            <!-- Закрепленный пост будет здесь -->
                        </div>
                    </div>
                    
                    <div id="profilePostsTab" class="profile-section" style="display: none;">
                        <div class="profile-section-title">Мои посты</div>
                        <div id="userPostsList">
                            <!-- Посты пользователя будут загружены здесь -->
                        </div>
                    </div>
                    
                    <div id="profilePlaylistTab" class="profile-section" style="display: none;">
                        <div class="profile-section-title">Мой плейлист</div>
                        <div class="playlist-container" id="playlistContainer">
                            <!-- Плейлист будет здесь -->
                        </div>
                        
                        <div class="profile-section-title" style="margin-top: 30px;">Добавить трек</div>
                        <div class="add-playlist-form">
                            <input type="text" class="playlist-input" id="trackTitle" placeholder="Название трека">
                            <input type="text" class="playlist-input" id="trackArtist" placeholder="Исполнитель">
                            <div class="form-group">
                                <label for="trackFile">MP3 файл (обязательно)</label>
                                <input type="file" id="trackFile" class="form-control" accept="audio/mp3" required>
                            </div>
                            <button class="btn btn-submit" onclick="addToPlaylist()" style="width: auto;">Добавить</button>
                        </div>
                    </div>
                    
                    <div id="profileSettingsTab" class="profile-section" style="display: none;">
                        <div class="profile-section-title">Настройки профиля</div>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="avatarPreview">
                                <!-- Превью аватара -->
                            </div>
                            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar()">
                            <button class="btn btn-submit" onclick="document.getElementById('avatarInput').click()" style="width: auto;">Выбрать аватар</button>
                            <button class="btn btn-submit" onclick="uploadAvatar()" style="width: auto; margin-top: 10px;">Сохранить аватар</button>
                        </div>
                        <form id="profileForm" onsubmit="saveProfile(event)">
                            <div class="form-group">
                                <label for="editUsername">Имя пользователя</label>
                                <input type="text" id="editUsername" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="editEmail">Email</label>
                                <input type="email" id="editEmail" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="editFullName">Полное имя</label>
                                <input type="text" id="editFullName" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="editLocation">Местоположение</label>
                                <input type="text" id="editLocation" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="editBio">О себе</label>
                                <textarea id="editBio" class="form-control" rows="4"></textarea>
                            </div>
                            <button type="submit" class="btn-submit">Сохранить изменения</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно входа -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h2 class="modal-title">Вход</h2>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginUsername">Имя пользователя</label>
                    <input type="text" id="loginUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Пароль</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn-submit">Войти</button>
            </form>
            <p style="text-align: center; margin-top: 15px; color: #a0a0a0; font-family: 'Courier New', monospace;">
                Нет аккаунта? <a href="#" onclick="showRegisterModal()" style="color: #b30000;">Зарегистрируйтесь</a>
            </p>
        </div>
    </div>
    
    <!-- Модальное окно регистрации -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
            <h2 class="modal-title">Регистрация</h2>
            <form id="registerForm" onsubmit="register(event)">
                <div class="form-group">
                    <label for="regUsername">Имя пользователя</label>
                    <input type="text" id="regUsername" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Пароль</label>
                    <input type="password" id="regPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Подтвердите пароль</label>
                    <input type="password" id="regConfirmPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn-submit">Зарегистрироваться</button>
            </form>
            <p style="text-align: center; margin-top: 15px; color: #a0a0a0; font-family: 'Courier New', monospace;">
                Уже есть аккаунт? <a href="#" onclick="showLoginModal()" style="color: #b30000;">Войдите</a>
            </p>
        </div>
    </div>
    
    <script>
        // Проверяем, есть ли сохраненный пользователь в localStorage
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let avatarFile = null;
        let postMediaFiles = [];
        let onlineUsers = {};
        let onlineCheckInterval;
        let currentAudio = null; // Текущий воспроизводимый аудиофайл
        
        // Инициализация данных при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация данных, если их нет
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify([]));
            }
            
            if (!localStorage.getItem('posts')) {
                localStorage.setItem('posts', JSON.stringify([]));
            }
            
            // Инициализация данных об онлайн пользователях
            if (!localStorage.getItem('onlineUsers')) {
                localStorage.setItem('onlineUsers', JSON.stringify({}));
            } else {
                onlineUsers = JSON.parse(localStorage.getItem('onlineUsers'));
            }
            
            updateUserPanel();
            loadPosts();
            updateStats();
            updateOnlineUsers();
            
            // Если пользователь авторизован, обновляем его статус онлайн
            if (currentUser) {
                updateUserOnlineStatus();
            }
            
            // Запускаем интервал для проверки онлайн статуса
            startOnlineCheckInterval();
            
            // Обработчик для предпросмотра медиа в посте
            document.getElementById('postMedia').addEventListener('change', function(e) {
                const preview = document.getElementById('mediaPreview');
                preview.innerHTML = '';
                postMediaFiles = [];
                
                for (let i = 0; i < e.target.files.length; i++) {
                    const file = e.target.files[i];
                    postMediaFiles.push(file);
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        let mediaElement;
                        if (file.type.startsWith('image/')) {
                            mediaElement = document.createElement('img');
                            mediaElement.src = event.target.result;
                        } else if (file.type.startsWith('video/')) {
                            mediaElement = document.createElement('video');
                            mediaElement.src = event.target.result;
                            mediaElement.controls = true;
                        }
                        
                        if (mediaElement) {
                            mediaElement.style.maxWidth = '200px';
                            mediaElement.style.maxHeight = '200px';
                            mediaElement.style.marginRight = '10px';
                            preview.appendChild(mediaElement);
                        }
                    };
                    reader.readAsDataURL(file);
                }
                
                if (e.target.files.length > 0) {
                    preview.classList.add('active');
                } else {
                    preview.classList.remove('active');
                }
            });
            
            // Обработчик клика по логотипу для перехода на главную
            document.querySelector('.logo').addEventListener('click', showMainContent);
            
            // Если пользователь авторизован, показываем форму создания поста
            if (currentUser) {
                document.getElementById('postFormContainer').style.display = 'block';
            }
        });
        
        // Функция для обновления панели пользователя
        function updateUserPanel() {
            const userPanel = document.getElementById('userPanel');
            
            if (currentUser) {
                userPanel.innerHTML = `
                    <button class="btn btn-profile" onclick="showProfile()">
                        <span id="userAvatarSmall">${getInitials(currentUser.username)}</span>
                        ${currentUser.username}
                    </button>
                    <button class="btn btn-logout" onclick="logout()">Выйти</button>
                `;
                
                // Обновляем маленький аватар, если он есть
                if (currentUser.avatar) {
                    const smallAvatar = document.getElementById('userAvatarSmall');
                    smallAvatar.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width: 20px; height: 20px; border-radius: 50%;">`;
                }
            } else {
                userPanel.innerHTML = `
                    <button class="btn btn-login" onclick="showLoginModal()">Войти</button>
                    <button class="btn btn-register" onclick="showRegisterModal()">Регистрация</button>
                `;
            }
        }
        
        // Функция для получения инициалов из имени пользователя
        function getInitials(username) {
            if (!username) return '';
            const parts = username.split(' ');
            if (parts.length > 1) {
                return parts[0][0] + parts[1][0];
            }
            return username.substring(0, 2);
        }
        
        // Функции для работы с модальными окнами
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }
        
        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'flex';
            closeModal('loginModal');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Функция входа
        function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            // Проверяем, есть ли такой пользователь в localStorage
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateUserPanel();
                closeModal('loginModal');
                
                // Обновляем статус онлайн
                updateUserOnlineStatus();
                
                // Очищаем форму
                document.getElementById('loginForm').reset();
                
                // Показываем форму создания поста
                document.getElementById('postFormContainer').style.display = 'block';
                
                // Обновляем посты
                loadPosts();
                
                alert('Вы успешно вошли в систему!');
            } else {
                alert('Неверное имя пользователя или пароль!');
            }
        }
        
        // Функция регистрации
        function register(event) {
            event.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            // Проверяем совпадение паролей
            if (password !== confirmPassword) {
                alert('Пароли не совпадают!');
                return;
            }
            
            // Проверяем, есть ли уже такой пользователь
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userExists = users.some(u => u.username === username || u.email === email);
            
            if (userExists) {
                alert('Пользователь с таким именем или email уже существует!');
                return;
            }
            
            // Создаем нового пользователя
            const newUser = {
                username,
                email,
                password,
                fullName: '',
                location: '',
                bio: '',
                regDate: new Date().toLocaleDateString(),
                posts: 0,
                threads: 0,
                reputation: 0,
                avatar: null,
                likedPosts: [],
                playlist: [],
                pinnedPost: null
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            // Автоматически входим под новым пользователем
            currentUser = newUser;
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            updateUserPanel();
            closeModal('registerModal');
            
            // Обновляем статус онлайн
            updateUserOnlineStatus();
            
            // Очищаем форму
            document.getElementById('registerForm').reset();
            
            // Показываем форму создания поста
            document.getElementById('postFormContainer').style.display = 'block';
            
            // Обновляем посты
            loadPosts();
            
            alert('Регистрация прошла успешно! Добро пожаловать на форум!');
        }
        
        // Функция выхода
        function logout() {
            // Удаляем пользователя из списка онлайн
            if (currentUser) {
                delete onlineUsers[currentUser.username];
                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
                updateOnlineUsers();
            }
            
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserPanel();
            showMainContent();
            
            // Скрываем форму создания поста
            document.getElementById('postFormContainer').style.display = 'none';
            
            alert('Вы успешно вышли из системы.');
        }
        
        // Функция показа профиля
        function showProfile() {
            if (!currentUser) return;
            
            // Заполняем данные профиля
            const profileAvatar = document.getElementById('profileAvatar');
            profileAvatar.innerHTML = currentUser.avatar 
                ? `<img src="${currentUser.avatar}" alt="${currentUser.username}">` 
                : getInitials(currentUser.username);
            
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileRegDate').textContent = currentUser.regDate;
            document.getElementById('profilePosts').textContent = currentUser.posts || 0;
            document.getElementById('profileThreads').textContent = currentUser.threads || 0;
            document.getElementById('profileReputation').textContent = currentUser.reputation || 0;
            document.getElementById('profileFullName').textContent = currentUser.fullName || 'Не указано';
            document.getElementById('profileLocation').textContent = currentUser.location || 'Не указано';
            document.getElementById('profileBio').textContent = currentUser.bio || 'Пользователь пока ничего о себе не рассказал.';
            
            // Заполняем форму редактирования
            document.getElementById('editUsername').value = currentUser.username;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editFullName').value = currentUser.fullName || '';
            document.getElementById('editLocation').value = currentUser.location || '';
            document.getElementById('editBio').value = currentUser.bio || '';
            
            // Настраиваем превью аватара
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = currentUser.avatar 
                ? `<img src="${currentUser.avatar}" alt="Аватар">` 
                : getInitials(currentUser.username);
            
            // Загружаем посты пользователя
            loadUserPosts();
            
            // Загружаем плейлист
            loadPlaylist();
            
            // Загружаем закрепленный пост
            loadPinnedPost();
            
            // Показываем контент профиля и скрываем основной
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';
            
            // Активируем вкладку информации
            showProfileTab('info');
        }
        
        // Функция показа основного контента
        function showMainContent() {
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('profileContent').style.display = 'none';
            loadPosts();
        }
        
        // Функция переключения вкладок профиля
        function showProfileTab(tabId) {
            // Скрываем все вкладки
            document.getElementById('profileInfoTab').style.display = 'none';
            document.getElementById('profilePostsTab').style.display = 'none';
            document.getElementById('profilePlaylistTab').style.display = 'none';
            document.getElementById('profileSettingsTab').style.display = 'none';
            
            // Показываем выбранную вкладку
            document.getElementById(`profile${tabId.charAt(0).toUpperCase() + tabId.slice(1)}Tab`).style.display = 'block';
            
            // Обновляем активный пункт меню
            const menuItems = document.querySelectorAll('.profile-menu-item');
            menuItems.forEach(item => item.classList.remove('active'));
            
            const activeItem = Array.from(menuItems).find(item => 
                item.textContent.toLowerCase().includes(tabId)
            );
            
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }
        
        // Функция сохранения профиля
        function saveProfile(event) {
            event.preventDefault();
            
            // Обновляем данные пользователя
            currentUser.username = document.getElementById('editUsername').value;
            currentUser.email = document.getElementById('editEmail').value;
            currentUser.fullName = document.getElementById('editFullName').value;
            currentUser.location = document.getElementById('editLocation').value;
            currentUser.bio = document.getElementById('editBio').value;
            
            // Обновляем данные в localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Обновляем список пользователей
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Обновляем панель пользователя
            updateUserPanel();
            
            // Обновляем отображаемые данные профиля
            showProfileTab('info');
            
            alert('Изменения сохранены успешно!');
        }
        
        // Функция предпросмотра аватара
        function previewAvatar() {
            const file = document.getElementById('avatarInput').files[0];
            if (!file) return;
            
            avatarFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarPreview = document.getElementById('avatarPreview');
                avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Превью аватара">`;
            };
            reader.readAsDataURL(file);
        }
        
        // Функция загрузки аватара
        function uploadAvatar() {
            if (!avatarFile) {
                alert('Пожалуйста, выберите изображение для аватара!');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentUser.avatar = e.target.result;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем список пользователей
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Обновляем аватар в профиле
                const profileAvatar = document.getElementById('profileAvatar');
                profileAvatar.innerHTML = `<img src="${e.target.result}" alt="${currentUser.username}">`;
                
                // Обновляем маленький аватар
                const smallAvatar = document.getElementById('userAvatarSmall');
                smallAvatar.innerHTML = `<img src="${e.target.result}" alt="${currentUser.username}" style="width: 20px; height: 20px; border-radius: 50%;">`;
                
                alert('Аватар успешно обновлен!');
            };
            reader.readAsDataURL(avatarFile);
        }
        
        // Функция создания поста
        function createPost(event) {
            event.preventDefault();
            
            if (!currentUser) {
                alert('Для создания поста необходимо авторизоваться!');
                return;
            }
            
            const title = document.getElementById('postTitle').value;
            const text = document.getElementById('postText').value;
            
            if (!text.trim()) {
                alert('Текст поста не может быть пустым!');
                return;
            }
            
            // Создаем новый пост
            const newPost = {
                id: Date.now(),
                author: currentUser.username,
                authorAvatar: currentUser.avatar || null,
                title: title.trim(),
                text: text.trim(),
                date: new Date().toLocaleString(),
                likes: 0,
                likedBy: [],
                comments: [],
                media: []
            };
            
            // Обрабатываем медиафайлы
            const mediaPromises = Array.from(postMediaFiles).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        resolve({
                            type: file.type.startsWith('image/') ? 'image' : file.type.startsWith('video/') ? 'video' : 'file',
                            url: event.target.result,
                            name: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            Promise.all(mediaPromises).then(mediaItems => {
                newPost.media = mediaItems;
                
                // Сохраняем пост в localStorage
                const posts = JSON.parse(localStorage.getItem('posts')) || [];
                posts.unshift(newPost); // Добавляем в начало массива
                localStorage.setItem('posts', JSON.stringify(posts));
                
                // Увеличиваем счетчик постов пользователя
                currentUser.posts = (currentUser.posts || 0) + 1;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем список пользователей
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Очищаем форму
                document.getElementById('postTitle').value = '';
                document.getElementById('postText').value = '';
                document.getElementById('postMedia').value = '';
                document.getElementById('mediaPreview').innerHTML = '';
                document.getElementById('mediaPreview').classList.remove('active');
                postMediaFiles = [];
                
                // Обновляем список постов
                loadPosts();
                
                // Обновляем статистику
                updateStats();
                
                alert('Пост успешно опубликован!');
            });
        }
        
        // Функция загрузки постов
        function loadPosts(searchQuery = '') {
            const postsList = document.getElementById('postsList');
            postsList.innerHTML = '';
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            
            let filteredPosts = posts;
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filteredPosts = posts.filter(post => 
                    (post.title && post.title.toLowerCase().includes(query)) || 
                    post.text.toLowerCase().includes(query) ||
                    post.author.toLowerCase().includes(query)
                );
            }
            
            if (filteredPosts.length === 0) {
                postsList.innerHTML = '<p style="text-align: center; font-family: \'Courier New\', monospace;">' + 
                    (searchQuery ? 'Ничего не найдено.' : 'Пока нет сообщений. Будьте первым!') + '</p>';
                return;
            }
            
            filteredPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.id = `post-${post.id}`;
                
                // Получаем аватар автора из данных пользователя
                let authorAvatar = post.authorAvatar;
                if (!authorAvatar) {
                    const users = JSON.parse(localStorage.getItem('users')) || [];
                    const author = users.find(u => u.username === post.author);
                    if (author && author.avatar) {
                        authorAvatar = author.avatar;
                    }
                }
                
                // Проверяем, лайкнул ли текущий пользователь этот пост
                const isLiked = currentUser && post.likedBy && post.likedBy.includes(currentUser.username);
                
                postElement.innerHTML = `
                    <div class="post-avatar">
                        ${authorAvatar ? `<img src="${authorAvatar}" alt="${post.author}">` : getInitials(post.author)}
                    </div>
                    <div class="post-content">
                        <div class="post-header">
                            <div class="post-author">${post.author}</div>
                            <div class="post-date">${post.date}</div>
                        </div>
                        ${post.title ? `<h4 style="margin-bottom: 10px; color: #b30000; font-family: 'Courier New', monospace;">${post.title}</h4>` : ''}
                        <div class="post-text">${post.text.replace(/\n/g, '<br>')}</div>
                        
                        ${post.media && post.media.length > 0 ? `
                            <div class="post-media">
                                ${post.media.map(item => 
                                    item.type === 'image' 
                                        ? `<img src="${item.url}" alt="Изображение">`
                                        : item.type === 'video'
                                        ? `<video src="${item.url}" controls></video>`
                                        : `<a href="${item.url}" download="${item.name}">Скачать файл: ${item.name}</a>`
                                ).join('<br>')}
                            </div>
                        ` : ''}
                        
                        <div class="post-actions">
                            <div class="post-action like-btn" onclick="toggleLike(${post.id})">
                                ${isLiked ? '❤️' : '🤍'} Нравится (${post.likes || 0})
                            </div>
                            <div class="post-action" onclick="toggleCommentForm(${post.id})">
                                Комментировать
                            </div>
                            ${post.author === currentUser?.username ? `
                                <div class="post-action" onclick="pinPost(${post.id})">Закрепить</div>
                                <div class="post-action" onclick="deletePost(${post.id})">Удалить</div>
                            ` : ''}
                        </div>
                        
                        <div id="comment-form-${post.id}" class="comment-form">
                            <textarea class="form-control" id="comment-text-${post.id}" placeholder="Ваш комментарий" rows="2"></textarea>
                            <button class="btn-submit" style="padding: 5px 10px; width: auto;" onclick="addComment(${post.id})">Отправить</button>
                        </div>
                        
                        ${post.comments && post.comments.length > 0 ? `
                            <div class="comments-container">
                                ${post.comments.map(comment => `
                                    <div class="comment">
                                        <div class="comment-header">
                                            <div class="comment-author">${comment.author}</div>
                                            <div class="comment-date">${comment.date}</div>
                                        </div>
                                        <div class="comment-text">${comment.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                postsList.appendChild(postElement);
            });
        }
        
        // Функция поиска контента (посты и песни)
        function searchContent(event) {
            event.preventDefault();
            const searchQuery = document.getElementById('searchQuery').value.trim();
            const searchResults = document.getElementById('searchResults');
            
            if (!searchQuery) {
                searchResults.style.display = 'none';
                loadPosts();
                return;
            }
            
            // Поиск по постам
            loadPosts(searchQuery);
            
            // Поиск по песням в плейлистах пользователей
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const query = searchQuery.toLowerCase();
            
            let songsFound = [];
            
            users.forEach(user => {
                if (user.playlist && user.playlist.length > 0) {
                    user.playlist.forEach(track => {
                        if (track.title.toLowerCase().includes(query) || 
                            track.artist.toLowerCase().includes(query)) {
                            songsFound.push({
                                ...track,
                                username: user.username,
                                userAvatar: user.avatar
                            });
                        }
                    });
                }
            });
            
            if (songsFound.length > 0) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'block';
                
                songsFound.forEach(song => {
                    const songElement = document.createElement('div');
                    songElement.className = 'search-result-item';
                    
                    songElement.innerHTML = `
                        <div class="search-result-info">
                            <div class="search-result-title">${song.title}</div>
                            <div class="search-result-artist">${song.artist}</div>
                            <div class="search-result-user">
                                <span>Из плейлиста: </span>
                                ${song.userAvatar 
                                    ? `<img src="${song.userAvatar}" alt="${song.username}" style="width: 16px; height: 16px; border-radius: 50%; vertical-align: middle;">` 
                                    : ''}
                                <span>${song.username}</span>
                            </div>
                            ${song.audio ? `<audio src="${song.audio}" controls class="audio-player"></audio>` : ''}
                        </div>
                        ${currentUser 
                            ? `<button class="search-result-add" onclick="addSongToPlaylist('${song.title}', '${song.artist}', '${song.audio || ''}')">+</button>` 
                            : ''}
                    `;
                    
                    searchResults.appendChild(songElement);
                });
            } else {
                searchResults.style.display = 'none';
            }
        }
        
        // Функция добавления найденной песни в плейлист
        function addSongToPlaylist(title, artist, audio) {
            if (!currentUser) {
                alert('Для добавления песни в плейлист необходимо авторизоваться!');
                return;
            }
            
            // Инициализируем плейлист, если его нет
            if (!currentUser.playlist) {
                currentUser.playlist = [];
            }
            
            // Проверяем, есть ли уже такая песня в плейлисте
            const songExists = currentUser.playlist.some(
                song => song.title === title && song.artist === artist
            );
            
            if (songExists) {
                alert('Эта песня уже есть в вашем плейлисте!');
                return;
            }
            
            // Добавляем новую песню
            currentUser.playlist.push({
                title,
                artist,
                audio: audio || null
            });
            
            // Обновляем данные пользователя
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Обновляем список пользователей
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Обновляем плейлист
            loadPlaylist();
            
            alert('Песня добавлена в ваш плейлист!');
        }
        
        // Функция переключения лайка
        function toggleLike(postId) {
            if (!currentUser) {
                alert('Для этого действия необходимо авторизоваться!');
                return;
            }
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const postIndex = posts.findIndex(p => p.id === postId);
            
            if (postIndex === -1) return;
            
            const post = posts[postIndex];
            
            // Инициализируем массив likedBy, если его нет
            if (!post.likedBy) {
                post.likedBy = [];
            }
            
            const userIndex = post.likedBy.indexOf(currentUser.username);
            
            if (userIndex === -1) {
                // Добавляем лайк
                post.likes = (post.likes || 0) + 1;
                post.likedBy.push(currentUser.username);
            } else {
                // Удаляем лайк
                post.likes = Math.max(0, (post.likes || 0) - 1);
                post.likedBy.splice(userIndex, 1);
            }
            
            // Обновляем пост в хранилище
            posts[postIndex] = post;
            localStorage.setItem('posts', JSON.stringify(posts));
            
            // Обновляем отображение поста
            const likeBtn = document.querySelector(`#post-${postId} .like-btn`);
            if (likeBtn) {
                likeBtn.innerHTML = `${userIndex === -1 ? '❤️' : '🤍'} Нравится (${post.likes || 0})`;
            }
        }
        
        // Функция переключения формы комментария
        function toggleCommentForm(postId) {
            if (!currentUser) {
                alert('Для этого действия необходимо авторизоваться!');
                return;
            }
            
            const commentForm = document.getElementById(`comment-form-${postId}`);
            commentForm.style.display = commentForm.style.display === 'block' ? 'none' : 'block';
        }
        
        // Функция добавления комментария
        function addComment(postId) {
            const commentText = document.getElementById(`comment-text-${postId}`).value.trim();
            
            if (!commentText) {
                alert('Комментарий не может быть пустым!');
                return;
            }
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const postIndex = posts.findIndex(p => p.id === postId);
            
            if (postIndex === -1) return;
            
            const post = posts[postIndex];
            
            // Инициализируем массив комментариев, если его нет
            if (!post.comments) {
                post.comments = [];
            }
            
            // Добавляем новый комментарий
            const newComment = {
                id: Date.now(),
                author: currentUser.username,
                text: commentText,
                date: new Date().toLocaleTimeString()
            };
            
            post.comments.push(newComment);
            
            // Обновляем пост в хранилище
            posts[postIndex] = post;
            localStorage.setItem('posts', JSON.stringify(posts));
            
            // Очищаем поле комментария и скрываем форму
            document.getElementById(`comment-text-${postId}`).value = '';
            document.getElementById(`comment-form-${postId}`).style.display = 'none';
            
            // Обновляем отображение поста
            loadPosts();
        }
        
        // Функция загрузки постов пользователя
        function loadUserPosts() {
            const userPostsList = document.getElementById('userPostsList');
            userPostsList.innerHTML = '';
            
            if (!currentUser) return;
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const userPosts = posts.filter(post => post.author === currentUser.username);
            
            if (userPosts.length === 0) {
                userPostsList.innerHTML = '<p style="text-align: center; font-family: \'Courier New\', monospace;">Вы еще не создавали постов.</p>';
                return;
            }
            
            userPosts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.style.borderBottom = '1px solid #333';
                postElement.style.paddingBottom = '15px';
                postElement.style.marginBottom = '15px';
                
                postElement.innerHTML = `
                    <div class="post-header">
                        <div class="post-date">${post.date}</div>
                    </div>
                    ${post.title ? `<h4 style="margin-bottom: 10px; color: #b30000; font-family: 'Courier New', monospace;">${post.title}</h4>` : ''}
                    <div class="post-text">${post.text.replace(/\n/g, '<br>')}</div>
                    
                    ${post.media && post.media.length > 0 ? `
                        <div class="post-media">
                            ${post.media.map(item => 
                                item.type === 'image' 
                                    ? `<img src="${item.url}" alt="Изображение" style="max-width: 200px;">`
                                    : item.type === 'video'
                                    ? `<video src="${item.url}" controls style="max-width: 200px;"></video>`
                                    : `<a href="${item.url}" download="${item.name}">Скачать файл: ${item.name}</a>`
                            ).join('<br>')}
                        </div>
                    ` : ''}
                    
                    <div class="post-actions">
                        <div class="post-action">Нравится (${post.likes || 0})</div>
                        <div class="post-action">Комментарии (${post.comments ? post.comments.length : 0})</div>
                        ${post.id === currentUser.pinnedPost ? '<div class="post-action" style="color: #b30000;">Закреплено</div>' : ''}
                        <div class="post-action" onclick="pinPost(${post.id})">${post.id === currentUser.pinnedPost ? 'Открепить' : 'Закрепить'}</div>
                        <div class="post-action" onclick="deletePost(${post.id})">Удалить</div>
                    </div>
                `;
                
                userPostsList.appendChild(postElement);
            });
        }
        
        // Функция закрепления поста
        function pinPost(postId) {
            if (!currentUser) return;
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const post = posts.find(p => p.id === postId);
            
            if (!post) return;
            
            // Если пост уже закреплен, открепляем его
            if (currentUser.pinnedPost === postId) {
                currentUser.pinnedPost = null;
            } else {
                currentUser.pinnedPost = postId;
            }
            
            // Обновляем данные пользователя
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Обновляем список пользователей
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === currentUser.email);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Обновляем закрепленный пост
            loadPinnedPost();
            
            // Обновляем список постов пользователя
            loadUserPosts();
            
            alert(currentUser.pinnedPost === postId ? 'Пост закреплен!' : 'Пост откреплен!');
        }
        
        // Функция загрузки закрепленного поста
        function loadPinnedPost() {
            const pinnedPostContainer = document.getElementById('pinnedPostContainer');
            pinnedPostContainer.innerHTML = '';
            
            if (!currentUser || !currentUser.pinnedPost) {
                pinnedPostContainer.innerHTML = '<p style="font-family: \'Courier New\', monospace; color: #a0a0a0;">Нет закрепленного поста</p>';
                return;
            }
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const post = posts.find(p => p.id === currentUser.pinnedPost);
            
            if (!post) {
                pinnedPostContainer.innerHTML = '<p style="font-family: \'Courier New\', monospace; color: #a0a0a0;">Закрепленный пост не найден</p>';
                return;
            }
            
            const pinnedPostElement = document.createElement('div');
            pinnedPostElement.className = 'pinned-post';
            
            pinnedPostElement.innerHTML = `
                <div class="post-header">
                    <div class="post-author">${post.author}</div>
                    <div class="post-date">${post.date}</div>
                </div>
                ${post.title ? `<h4 style="margin-bottom: 10px; color: #b30000; font-family: 'Courier New', monospace;">${post.title}</h4>` : ''}
                <div class="post-text">${post.text.replace(/\n/g, '<br>')}</div>
                
                ${post.media && post.media.length > 0 ? `
                    <div class="post-media">
                        ${post.media.map(item => 
                            item.type === 'image' 
                                ? `<img src="${item.url}" alt="Изображение" style="max-width: 200px;">`
                                : item.type === 'video'
                                ? `<video src="${item.url}" controls style="max-width: 200px;"></video>`
                                : `<a href="${item.url}" download="${item.name}">Скачать файл: ${item.name}</a>`
                        ).join('<br>')}
                    </div>
                ` : ''}
                
                <div class="post-actions">
                    <div class="post-action">Нравится (${post.likes || 0})</div>
                    <div class="post-action">Комментарии (${post.comments ? post.comments.length : 0})</div>
                </div>
            `;
            
            pinnedPostContainer.appendChild(pinnedPostElement);
        }
        
        // Функция загрузки плейлиста
        function loadPlaylist() {
            const playlistContainer = document.getElementById('playlistContainer');
            playlistContainer.innerHTML = '';
            
            if (!currentUser || !currentUser.playlist || currentUser.playlist.length === 0) {
                playlistContainer.innerHTML = '<p style="font-family: \'Courier New\', monospace; color: #a0a0a0;">Плейлист пуст</p>';
                return;
            }
            
            currentUser.playlist.forEach((track, index) => {
                const trackElement = document.createElement('div');
                trackElement.className = 'playlist-item';
                
                trackElement.innerHTML = `
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${track.title}</div>
                        <div class="playlist-item-artist">${track.artist}</div>
                        ${track.audio ? `
                            <audio src="${track.audio}" controls class="audio-player"></audio>
                        ` : ''}
                    </div>
                    <div class="playlist-controls">
                        <button class="playlist-btn" onclick="playTrack(${index})">▶️</button>
                        <button class="playlist-btn" onclick="removeFromPlaylist(${index})">❌</button>
                    </div>
                `;
                
                playlistContainer.appendChild(trackElement);
            });
        }
        
        // Функция добавления трека в плейлист
        function addToPlaylist() {
            if (!currentUser) return;
            
            const title = document.getElementById('trackTitle').value.trim();
            const artist = document.getElementById('trackArtist').value.trim();
            const fileInput = document.getElementById('trackFile');
            const file = fileInput.files[0];
            
            if (!title || !artist) {
                alert('Пожалуйста, заполните все обязательные поля!');
                return;
            }
            
            if (!file) {
                alert('Пожалуйста, прикрепите MP3 файл!');
                return;
            }
            
            // Проверяем, что файл имеет правильный формат
            if (!file.type.includes('audio/mp3') && !file.name.toLowerCase().endsWith('.mp3')) {
                alert('Пожалуйста, загрузите файл в формате MP3!');
                return;
            }
            
            // Инициализируем плейлист, если его нет
            if (!currentUser.playlist) {
                currentUser.playlist = [];
            }
            
            // Проверяем, есть ли уже такая песня в плейлисте
            const songExists = currentUser.playlist.some(
                song => song.title === title && song.artist === artist
            );
            
            if (songExists) {
                alert('Эта песня уже есть в вашем плейлисте!');
                return;
            }
            
            // Читаем файл
            const reader = new FileReader();
            reader.onload = function(e) {
                // Добавляем новую песню с аудиофайлом
                currentUser.playlist.push({
                    title,
                    artist,
                    audio: e.target.result
                });
                
                // Обновляем данные пользователя
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем список пользователей
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Очищаем поля ввода
                document.getElementById('trackTitle').value = '';
                document.getElementById('trackArtist').value = '';
                fileInput.value = '';
                
                // Обновляем плейлист
                loadPlaylist();
                
                alert('Трек добавлен в плейлист!');
            };
            reader.readAsDataURL(file);
        }
        
        // Функция удаления трека из плейлиста
        function removeFromPlaylist(index) {
            if (!currentUser || !currentUser.playlist) return;
            
            if (confirm('Удалить этот трек из плейлиста?')) {
                currentUser.playlist.splice(index, 1);
                
                // Обновляем данные пользователя
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем список пользователей
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                // Обновляем плейлист
                loadPlaylist();
            }
        }
        
        // Функция воспроизведения трека
        function playTrack(index) {
            if (!currentUser || !currentUser.playlist) return;
            
            const track = currentUser.playlist[index];
            
            if (!track.audio) {
                alert(`Трек "${track.title} - ${track.artist}" не имеет аудиофайла`);
                return;
            }
            
            // Останавливаем текущее воспроизведение, если есть
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            // Создаем новый аудиоэлемент
            currentAudio = new Audio(track.audio);
            currentAudio.play();
            
            alert(`Воспроизведение: ${track.title} - ${track.artist}`);
        }
        
        // Функция удаления поста
        function deletePost(postId) {
            if (!confirm('Вы уверены, что хотите удалить этот пост?')) return;
            
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            const updatedPosts = posts.filter(post => post.id !== postId);
            localStorage.setItem('posts', JSON.stringify(updatedPosts));
            
            // Уменьшаем счетчик постов пользователя
            if (currentUser) {
                currentUser.posts = Math.max(0, (currentUser.posts || 0) - 1);
                
                // Если удаляемый пост был закреплен, снимаем закрепление
                if (currentUser.pinnedPost === postId) {
                    currentUser.pinnedPost = null;
                }
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Обновляем список пользователей
                const users = JSON.parse(localStorage.getItem('users')) || [];
                const userIndex = users.findIndex(u => u.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }
            
            // Обновляем списки постов
            loadPosts();
            loadUserPosts();
            loadPinnedPost();
            
            // Обновляем статистику
            updateStats();
            
            alert('Пост успешно удален!');
        }
        
        // Функция обновления статистики
        function updateStats() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const posts = JSON.parse(localStorage.getItem('posts')) || [];
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalPosts').textContent = posts.length;
            
            // Обновляем количество онлайн пользователей
            updateOnlineUsersCount();
        }
        
        // Функция обновления статуса онлайн пользователя
        function updateUserOnlineStatus() {
            if (!currentUser) return;
            
            // Обновляем время последней активности
            onlineUsers[currentUser.username] = {
                username: currentUser.username,
                avatar: currentUser.avatar,
                lastActivity: Date.now()
            };
            
            localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
            updateOnlineUsers();
        }
        
        // Функция обновления списка онлайн пользователей
        function updateOnlineUsers() {
            const onlineUsersList = document.getElementById('onlineUsersList');
            onlineUsersList.innerHTML = '';
            
            // Получаем список пользователей для аватаров
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            // Фильтруем пользователей, которые были активны в последние 5 минут
            const now = Date.now();
            const activeUsers = Object.values(onlineUsers).filter(user => 
                now - user.lastActivity < 5 * 60 * 1000 // 5 минут
            );
            
            // Сортируем по времени последней активности (новые сверху)
            activeUsers.sort((a, b) => b.lastActivity - a.lastActivity);
            
            if (activeUsers.length === 0) {
                onlineUsersList.innerHTML = '<li style="font-family: \'Courier New\', monospace;">Нет активных пользователей</li>';
                return;
            }
            
            activeUsers.forEach(user => {
                const userData = users.find(u => u.username === user.username) || {};
                
                const li = document.createElement('li');
                li.className = 'online-user';
                
                li.innerHTML = `
                    <div class="online-user-avatar">
                        ${user.avatar ? `<img src="${user.avatar}" alt="${user.username}">` : getInitials(user.username)}
                    </div>
                    <span>${user.username}</span>
                `;
                
                onlineUsersList.appendChild(li);
            });
            
            // Обновляем счетчик онлайн
            updateOnlineUsersCount();
        }
        
        // Функция обновления счетчика онлайн пользователей
        function updateOnlineUsersCount() {
            const now = Date.now();
            const activeUsers = Object.values(onlineUsers).filter(user => 
                now - user.lastActivity < 5 * 60 * 1000 // 5 минут
            );
            
            document.getElementById('onlineUsers').textContent = activeUsers.length;
        }
        
        // Функция запуска интервала проверки онлайн статуса
        function startOnlineCheckInterval() {
            // Очищаем предыдущий интервал, если он был
            if (onlineCheckInterval) {
                clearInterval(onlineCheckInterval);
            }
            
            // Запускаем новый интервал (каждую минуту)
            onlineCheckInterval = setInterval(() => {
                // Обновляем статус текущего пользователя
                if (currentUser) {
                    updateUserOnlineStatus();
                }
                
                // Обновляем список онлайн пользователей
                updateOnlineUsers();
            }, 60 * 1000);
        }
        
        // Закрываем модальные окна при клике вне их
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
        
        // Обновляем статус онлайн при закрытии страницы
        window.addEventListener('beforeunload', function() {
            if (currentUser) {
                // Удаляем пользователя из списка онлайн
                delete onlineUsers[currentUser.username];
                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
            }
        });
    </script>
</body>
</html>